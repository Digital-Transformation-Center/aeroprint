<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AeroPrint</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
  <div class="container">

    <!-- Starling Status Top Right -->
    <div class="starling-status-top">
      Starling: {% if starling %}Connected{% else %}Disconnected{% endif %}
    </div>

    <!-- Title Banner -->
    <div class="title-banner">
      <img src="{{ url_for('static', filename='images/aeroprint_title.png') }}" alt="AeroPrint Logo">
    </div>
    {% if stage != "Preflight" %}
      <div class="top-left-stop">
        <button id="emergency-stop" onclick="sendStopCommand()">ðŸ›‘</button>
      </div>
    {% endif %}

    <!-- Dev Phase Preview Menu (hidden by default, toggled with Ctrl+Q) -->
    <div id="dev-phase-menu" style="display:none; position:fixed; bottom:60px; right:24px; z-index:200; background:#222; padding:8px 16px; border-radius:8px; box-shadow:0 2px 8px #00eaff;">
      <label for="dev-phase" style="color:#b0eaff; font-weight:bold;">Dev Phase Preview:</label>
      <select id="dev-phase" onchange="simulatePhase(this.value)">
        {% for phase in ["Preflight", "Scanning", "Processing", "Meshing", "Slicing", "Printing"] %}
          <option value="{{ phase }}">{{ phase }}</option>
        {% endfor %}
      </select>
    </div>

    <!-- Status Bar -->
    <div class="status-bar">
      {% for phase in ["Preflight", "Scanning", "Processing", "Meshing", "Slicing", "Printing"] %}
        <div class="status {% if phase == stage %}active{% endif %}">{{ phase }}</div>
      {% endfor %}
    </div>

    <!-- Top Row: Camera (left) & Flight Path (right) -->
    <div class="data-row">

      <!-- Camera Section -->
      <div class="camera-view">
        <h3>Starling Camera View</h3>
        <div class="camera-box">[Live Feed Placeholder]</div>
        <div class="phase-description">
          {% if stage == "Preflight" %}
            <p></p>
            <button id="action-btn"
                    class="{{ 'start-btn' if command != 'START' else 'stop-btn' }}"
                    onclick="toggleAction()">
              {{ 'START' if command != 'START' else 'STOP' }}
            </button>
          {% else %}
            <p></p>
            <div class="progress-container">
              <div id="progress-bar" class="progress-bar"></div>
            </div>
          {% endif %}
        </div>
      </div>

      <!-- Flight Path Section -->
      <div class="flight-path">
        <h3>Flight Path Graphic</h3>
        <div class="path-box">[Overlay Placeholder]</div>

        <!-- Print Size Selector -->
        <div class="size-selector">
          <button id="btn-SM" class="size-btn" onclick="selectSize('SM')">SM</button>
          <button id="btn-MED" class="size-btn" onclick="selectSize('MED')">MED</button>
          <button id="btn-LG" class="size-btn" onclick="selectSize('LG')">LG</button>
        </div>
      </div>

    </div>
  </div>

  <!-- Dynamic Command Logic -->
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js" crossorigin="anonymous"></script>
  <script>
    const socket = io();
    let selectedSize = "{{ selected_size }}";  // store size for use during START

    function toggleAction() {
      const btn = document.getElementById('action-btn');
      const isStart = btn.classList.contains('start-btn');

      if (isStart) {
        // Going from START to STOP
        btn.textContent = "STOP";
        btn.classList.remove("start-btn");
        btn.classList.add("stop-btn");
        socket.emit('send_command', {
          command: "START",
          size: selectedSize
        });
      } else {
        // Going from STOP to START
        btn.textContent = "START";
        btn.classList.remove("stop-btn");
        btn.classList.add("start-btn");
        socket.emit('send_command', {
          command: "STOP",
          size: selectedSize
        });
      }
    }

    function selectSize(size) {
      selectedSize = size;
      // Update button highlighting
      ["SM", "MED", "LG"].forEach(s => {
        const btn = document.getElementById('btn-' + s);
        btn.classList.remove("active");
      });
      document.getElementById('btn-' + size).classList.add("active");
      // Do NOT emit any command here!
    }

    function simulatePhase(phase) {
      // Update status bar visuals
      document.querySelectorAll('.status-bar .status').forEach(elem => {
        elem.classList.remove('active');
        if (elem.textContent.trim() === phase) {
          elem.classList.add('active', 'slide-in');
          setTimeout(() => elem.classList.remove('slide-in'), 600);
        }
      });

      // Update phase description text
      updatePhaseDescription(phase);

      // Update layout: Stop button & progress bar
      const stopBtn = document.querySelector('.top-left-stop');
      const progressBarContainer = document.querySelector('.progress-container');
      const actionBtn = document.getElementById('action-btn');

      if (phase === "Preflight") {
        if (stopBtn) stopBtn.style.display = "none";
        if (progressBarContainer) progressBarContainer.style.display = "none";
        if (actionBtn) actionBtn.style.display = "inline-block";
      } else {
        if (actionBtn) actionBtn.style.display = "none";
        
        // Show Stop button
        if (stopBtn) {
          stopBtn.style.display = "block";
        } else {
          const stopDiv = document.createElement("div");
          stopDiv.className = "top-left-stop";
          stopDiv.innerHTML = `<button id="emergency-stop" onclick="sendStopCommand()">ðŸ›‘</button>`;
          document.body.appendChild(stopDiv);
        }

        // Show Progress Bar
        if (!progressBarContainer) {
          const container = document.createElement("div");
          container.className = "progress-container";
          container.innerHTML = `<div id="progress-bar" class="progress-bar"></div>`;
          document.querySelector('.phase-description').appendChild(container);
        } else {
          progressBarContainer.style.display = "block";
        }
      }
    }

    function typePhaseDescription(text) {
      const descDiv = document.querySelector('.phase-description');
      if (!descDiv) return;
      let p = descDiv.querySelector('p');
      if (!p) {
        p = document.createElement('p');
        descDiv.prepend(p);
      }
      p.textContent = ""; // Clear previous text

      let i = 0;
      function type() {
        if (i < text.length) {
          p.textContent += text.charAt(i);
          i++;
          setTimeout(type, 18); // Adjust speed here (ms per character)
        }
      }
      type();
    }

    function updatePhaseDescription(phase) {
      const text = phaseDescriptions[phase] || "";
      typePhaseDescription(text);
    }

    socket.on('command_response', data => {
      console.log("Server response:", data);
    });

    socket.on('status_update', function(data) {
      const allStatuses = document.querySelectorAll('.status-bar .status');
      allStatuses.forEach(div => {
        if (div.textContent.trim() === data.phase) {
          div.classList.add('active', 'slide-in');
          setTimeout(() => div.classList.remove('slide-in'), 600);
        } else {
          div.classList.remove('active');
        }
      });
      updatePhaseDescription(data.phase);
    });

    socket.on('progress_update', function(data) {
      const bar = document.getElementById('progress-bar');
      if (bar) bar.style.width = data.percent + '%';
    });

    function sendStopCommand() {
      socket.emit('emergency_stop');
      // Optionally show a message to the user
      alert("Emergency stop sent. Drone landing...");
    }

    // Toggle dev menu with Ctrl+Q
    document.addEventListener('keydown', function(e) {
      if (e.ctrlKey && (e.key === 'q' || e.key === 'Q')) {
        const menu = document.getElementById('dev-phase-menu');
        menu.style.display = (menu.style.display === 'none' || menu.style.display === '') ? 'block' : 'none';
        e.preventDefault();
      }
    });

    const phaseDescriptions = {
      "Preflight": "ðŸ“SELECT A SIZE AND PRESS START TO BEGIN THE SCAN PROCESS. A FLIGHT PATH WILL THEN BE CALCULATED AND LOADED INTO THE DRONE.",
      "Scanning": "ðŸ“¡ STARLING IS ACTIVELY FLYING THE SET PATH AND COLLECTING 3D SURFACE DATA USING ONBOARD DEPTH SENSORS.",
      "Processing": "ðŸ§¹ CAPTURED POINT CLOUDS ARE BEING CLEANED AND ALIGNED. NOISE REDUCTION AND FILTERING ARE APPLIED FOR PRECISION GEOMETRY.",
      "Meshing": "ðŸ§  POINT CLOUD DATA IS BEING TRANSFORMED INTO A FULL 3D MESHâ€”BUILDING SURFACE TOPOLOGY FROM FLIGHT SCANS.",
      "Slicing": "âœ‚ï¸ THE MESH MODEL IS SLICED INTO PRINTABLE LAYERS. G-CODE IS GENERATED TO PREPARE FOR PRINTING.",
      "Printing": "ðŸ–¨ï¸ PRINT OPERATION IS UNDERWAY. LAYERS ARE BEING DEPOSITED IN SEQUENCE USING THE GENERATED TOOLPATH."
    };

    // Update phase description on load
    document.addEventListener('DOMContentLoaded', () => {
      document.querySelectorAll('.phase-description p').forEach(p => {
        const phase = p.closest('.phase-description').getAttribute('data-phase');
        p.textContent = phaseDescriptions[phase] || '';
      });
      updatePhaseDescription("{{ stage }}"); // On page load
    });
  </script>
</body>
</html>
